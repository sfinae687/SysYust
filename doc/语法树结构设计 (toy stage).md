---
title: 语法树结构设计 (toy stage)

---

# 语法树结构设计 (toy stage)

## 辅助类

### `Type` 类型标识

  可具有 `const` 属性，
  SysY中左值未指定运算，限制在 `Expr::DeclRef` 、 `Expr::ArraySubscript` 中

#### 数字类型

SysY 仅支持一种整数类型和一种浮点类型。

`Int` 整数类型  
`Float` 浮点数类型

#### 派生类型

SysY 语法上的派生类型只有数组类型。标记为 `Array`. 作为复合类型,使用一个数字类型和一个表示长度的整数描述.

`Type::Pointer` 仅用作函数参数,表示最外层维数不可知的数组类型.  

`Function` 函数类型,使用一个返回类型和一个参数类型列表描述.  
参数类型可以是一个数字类型或一个指针类型.

#### 占位类型

`Void` SysY 中仅作为函数返回类型.

#### 归类

基础类型:`Int`,`Float`.

可作为数组参数的类型:基础类型,`Array`.

可作为指针参数的类型:可作为数组参数的类型.

参数类型:基础类型,`Pointer`.

可返回类型:基础类型,`Void`.

变量可能的类型:基础类型,`Array`,`Pointer`.

#### 实现细节

`Type` 实现为名为 `TypeBase` 的多态类型.其他所有类型从此派生.

[归类](#归类) 中的归类方法实现为返回布尔值的虚函数.

参数化的派生类型的标识对象通过一种 *工厂函数* 获取,以支持错误检测.

`Antlr4` 使得错误检查与抽象语法树无关.无需源码信息.

不可变性划分为变量的属性.

语言过于简单,语法保证了赋值的左运算元是左值.

## AST Node

设计原则,合理划分,保留必要信息.

SysY的语法顶层是所谓的"编译单元"由各种声明组成.

函数体(语句块),可以由语句或声明组成,不像早期C语言,SysY可以在任意位置书写声明.

需要说明的是语法解析并不保证流程控制语句一定符合语义约束.**此处需要额外的错误处理.**

`Node` 基类:带有一个访问器模式方法.以下所有类派生自`Node`.

- `Decl` 声明，作用域应配备上下文用以存储声明信息
  - `VarDecl` 变量的声明
    全局变量必须被初始化  
    每个 `VarDecl` 对象表示一个变量的声明. 在语法上可能存在并列声明多个变量,在处理时将其展开.  
    描述信息:不可变标志, 变量类型, 初始化器.
  - `Function`
    描述信息： 返回类型标识.
    子节点:参数声明，语句块.
  - `ParaDecl`
    描述信息：类型标识符
- `Stmt`
  - `Block`
     子节点:
     - `Stmt` 列表
  - `If`
     子节点:
     - 表达式"条件"
     - 子句 `Stmt`
     - else子句 `Stmt`
  - `While`
    - 表达式"条件"
    - 子句 `Stmt`
  - `Break`
  - `Continue`
  - `Return`
      子节点:
      - 可空的 `Expr`.
  - `Assign`
      子节点:
      - 左值表达式且类型为 Number
      - 表达式 `Expr`
  - `Empty`
  - `Expr`
      描述信息:类型标识
      - `IntLiteral` 表达式类型 `Int`
      - `FloatLiteral` 表达式类型为 `Float`
      - `Call`
         表达式类型为函数返回类型.
         描述信息:函数名标识  
         子节点:
         - `Expr` 列表
      - `UnaryOp` (`-`) 
         表达式类型为操作数类型
      - `BinaryOp` (`+` `-` `*` `/` `%`)
        二元运算符的左右操作数类型必须相同，其值类型为操作数的类型。
      - `LExpr` 左值表达式
          - `DeclRef` 变量的引用 表达类型为变量类型
          - `ArraySubscript` 数组索引 类型操作数类型为去除一维后的类型
  - `CondExpr` 
      - `Not` `!`
      - `Or` `||`
      - `And` `&&`
      - `Compare` 
      
以下节点，隐式生成。

- `ToInt` 表达式类型为 `Int`
- `ToFloat` 表达式类型为 `Float`
- `ToBool` 属于条件表达式 在条件表达式和表达式的连接处生成,执行一个布尔转换.

# 上下文

节点可能用到的信息：

- 符号信息
    - 符号名称
    - 符号类型 （变量/函数）
    - 符号附加信息
- 

构建的数据结构

- 符号表
- 